<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KTS Transport Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #151515;
            color: white;
        }
        .main-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .scroll-container {
            overflow-y: auto;
            flex-grow: 1;
            padding: 1.5rem;
            height: calc(100vh - 4rem); /* Adjust for header height */
        }
        input, select, textarea {
            background-color: #ffffff;
            color: #151515;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            outline: none;
            width: 100%;
        }
        input:focus, select:focus, textarea:focus {
            outline: 2px solid #46a5ff;
        }
        /* Custom scrollbar for a dark theme */
        .scroll-container::-webkit-scrollbar {
            width: 10px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: #2a2a2a;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background: #46a5ff;
            border-radius: 5px;
        }
        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: #3c91e0;
        }
        /* Table styles */
        .table-auto th {
            text-align: left;
            padding: 0.75rem 1rem;
            background-color: #1f1f1f;
            border-bottom: 2px solid #46a5ff;
        }
        .table-auto td {
            padding: 0.75rem 1rem;
        }
    </style>
</head>
<body class="bg-[#151515] text-white">

    <script>
        // Tailwind Configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-bg': '#151515',
                        'accent-blue': '#46a5ff',
                        'card-bg': '#2a2a2a',
                    },
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db, auth;
        let userId;

        // Global environment variables
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        async function initFirebase() {
            try {
                // If config is provided, initialize Firebase
                if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    console.log("Firebase initialized.");

                    // Auth handler
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (token) {
                        await signInWithCustomToken(auth, token);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            document.getElementById('user-id-display').textContent = 'User ID: ' + userId;
                            // Load data only after successful authentication
                            loadVehicles();
                            loadTrips();
                            loadVehicleExpenses();
                            loadOfficeExpenses();
                            loadHomeSummary();
                        } else {
                            userId = null;
                            document.getElementById('user-id-display').textContent = 'User ID: Anonymous (Data not persistent)';
                            showModal('Warning: Signed out. Data may not persist without proper user authentication.');
                        }
                    });
                } else {
                     document.getElementById('error-message').textContent = `Warning: Firebase config missing. Data persistence disabled.`;
                }

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('error-message').textContent = `Firebase error: ${error.message}.`;
            }
        }
        
        // --- Modal Logic ---
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const closeModal = () => modal.classList.add('hidden');
        document.getElementById('close-modal-btn').onclick = closeModal;

        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            setTimeout(closeModal, 3000); // Auto-close after 3 seconds
        }

        // --- Section Switching Logic ---
        const sections = ['home', 'vehicles', 'trips', 'vehicle-expenses', 'office-expenses', 'add-vehicle-section'];
        const navLinks = document.querySelectorAll('.nav-link');

        function showSection(sectionId) {
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    section.classList.toggle('hidden', id !== sectionId);
                }
            });
            navLinks.forEach(link => {
                link.classList.toggle('bg-accent-blue', link.dataset.section === sectionId);
                link.classList.toggle('bg-card-bg', link.dataset.section !== sectionId);
            });
            // Reload data if needed for the specific tab
            if (sectionId === 'trips') loadTrips();
            if (sectionId === 'vehicle-expenses') loadVehicleExpenses();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();
            showSection('home');
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showSection(e.currentTarget.dataset.section);
            });
        });

        // --- Firestore Data Operations ---

        function getCollection(collectionName) {
            // Data is private to the authenticated user
            return collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
        }

        function getDateFilterRange(filter) {
            const now = new Date();
            let fromDate = null;
            
            if (filter === 'Last 7 Days') {
                fromDate = new Date(now.setDate(now.getDate() - 7));
            } else if (filter === 'Last 30 Days') {
                fromDate = new Date(now.setDate(now.getDate() - 30));
            } else if (filter === 'Last 6 Months') {
                fromDate = new Date(now.setMonth(now.getMonth() - 6));
            } else if (filter === 'Last 12 Months') {
                fromDate = new Date(now.setFullYear(now.getFullYear() - 1));
            }
            if (fromDate) fromDate.setHours(0, 0, 0, 0); // Reset time for accurate comparison
            return fromDate;
        }

        // --- Home/Dashboard Logic ---

        async function loadHomeSummary() {
            if (!db || !userId) return;
            
            // 1. Vehicle Counts
            onSnapshot(getCollection('vehicles'), (snapshot) => {
                document.getElementById('total-vehicles').textContent = snapshot.size;
            }, (error) => console.error("Error fetching vehicle count:", error));

            // 2. Total Trip Profit (Last 30 days)
            const thirtyDaysAgo = getDateFilterRange('Last 30 Days');
            const tripsQuery = query(getCollection('trips'), orderBy('date', 'desc'));

            onSnapshot(tripsQuery, (querySnapshot) => {
                let income30 = 0;
                let expense30 = 0;

                querySnapshot.forEach(doc => {
                    const trip = doc.data();
                    if (new Date(trip.date) >= thirtyDaysAgo) {
                        income30 += parseFloat(trip.income) || 0;
                        expense30 += parseFloat(trip.expense) || 0;
                    }
                });

                const profit30 = income30 - expense30;
                document.getElementById('recent-profit').textContent = `₹${profit30.toFixed(2)}`;
                document.getElementById('recent-profit').classList.toggle('text-green-400', profit30 >= 0);
                document.getElementById('recent-profit').classList.toggle('text-red-400', profit30 < 0);
            }, (error) => console.error("Error fetching trip summary:", error));

            // 3. Total Vehicle Expenses (Last 30 days)
             const expensesQuery = query(getCollection('vehicle_expenses'), orderBy('date', 'desc'));
             onSnapshot(expensesQuery, (querySnapshot) => {
                let totalExpenses30 = 0;
                querySnapshot.forEach(doc => {
                    const expense = doc.data();
                    if (new Date(expense.date) >= thirtyDaysAgo) {
                        totalExpenses30 += parseFloat(expense.amount) || 0;
                    }
                });
                document.getElementById('recent-expenses').textContent = `₹${totalExpenses30.toFixed(2)}`;
            }, (error) => console.error("Error fetching expense summary:", error));
        }


        // --- Vehicle & Driver Logic ---
        const vehiclesContainer = document.getElementById('vehicles-container');
        const addVehicleForm = document.getElementById('add-vehicle-form');
        const vehiclesSection = document.getElementById('vehicles');
        const addVehicleSection = document.getElementById('add-vehicle-section');

        document.getElementById('add-vehicle-btn').addEventListener('click', () => {
            showSection('add-vehicle-section');
            addVehicleForm.reset();
            addVehicleForm.elements['id'].value = ''; // Clear ID for new entry
            document.getElementById('vehicle-form-title').textContent = 'Add New Vehicle';
        });

        document.getElementById('back-to-vehicles').addEventListener('click', () => {
            showSection('vehicles');
        });

        addVehicleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.submitter;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            const formData = new FormData(addVehicleForm);
            const data = Object.fromEntries(formData.entries());
            const vehicleId = data.id;
            
            // Convert numerical fields to numbers (or 0 if empty)
            data.loan_total = parseFloat(data.loan_total) || 0;
            data.loan_paid = parseFloat(data.loan_paid) || 0;
            data.loan_remaining = (data.loan_total - data.loan_paid).toFixed(2); // Calculate remaining loan
            
            try {
                if (vehicleId) {
                    delete data.id; // Don't save the ID field into the document data
                    await setDoc(doc(getCollection('vehicles'), vehicleId), data);
                    showModal('Vehicle updated successfully!');
                } else {
                    delete data.id;
                    await addDoc(getCollection('vehicles'), data);
                    showModal('Vehicle added successfully!');
                }
                addVehicleForm.reset();
                showSection('vehicles');
            } catch (e) {
                console.error("Error adding/updating document: ", e);
                showModal('Error saving vehicle. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Vehicle';
            }
        });

        function createVehicleCard(vehicle) {
            const card = document.createElement('div');
            const loanRemaining = (parseFloat(vehicle.loan_total || 0) - parseFloat(vehicle.loan_paid || 0)).toFixed(2);
            card.className = 'bg-card-bg rounded-lg p-6 shadow-xl border border-gray-700 flex flex-col justify-between transform transition duration-300 hover:scale-[1.02]';
            card.innerHTML = `
                <div class="flex-grow">
                    <h3 class="text-xl font-bold text-accent-blue mb-2">${vehicle.vehicle_name}</h3>
                    <p class="text-sm text-white"><i class="fas fa-id-badge mr-2 opacity-75"></i>Reg No: **${vehicle.reg_no}**</p>
                    <p class="text-sm text-white mt-1"><i class="fas fa-user-circle mr-2 opacity-75"></i>Driver: ${vehicle.driver_name || 'N/A'}</p>
                    <p class="text-sm text-white mt-1"><i class="fas fa-phone mr-2 opacity-75"></i>Contact: ${vehicle.driver_contact || 'N/A'}</p>
                    <p class="text-sm mt-4 font-semibold">Loan Remaining: <span class="text-lg ${loanRemaining > 0 ? 'text-red-400' : 'text-green-400'}">₹${loanRemaining}</span></p>
                    <div class="text-xs mt-3 space-y-1 p-2 bg-[#1f1f1f] rounded-md">
                        <p class="flex justify-between"><span>Ins. Expiry:</span> <span class="font-medium">${vehicle.ins_expiry || 'N/A'}</span></p>
                        <p class="flex justify-between"><span>Fitness Expiry:</span> <span class="font-medium">${vehicle.fitness_expiry || 'N/A'}</span></p>
                        <p class="flex justify-between"><span>PUC Expiry:</span> <span class="font-medium">${vehicle.puc_expiry || 'N/A'}</span></p>
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button class="edit-btn bg-accent-blue hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full w-full transition-colors duration-200 shadow-md" data-id="${vehicle.id}"><i class="fas fa-edit mr-1"></i> Edit</button>
                    <button class="delete-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full w-full transition-colors duration-200 shadow-md" data-id="${vehicle.id}"><i class="fas fa-trash-alt mr-1"></i> Delete</button>
                </div>
            `;
            card.querySelector('.edit-btn').addEventListener('click', () => editVehicle(vehicle));
            card.querySelector('.delete-btn').addEventListener('click', () => {
                if(confirm('Are you sure you want to delete this vehicle? This action cannot be undone.')) deleteVehicle(vehicle.id)
            });
            return card;
        }

        function editVehicle(vehicle) {
            document.getElementById('vehicle-form-title').textContent = 'Edit Vehicle Details';
            addVehicleForm.elements['id'].value = vehicle.id;
            addVehicleForm.elements['vehicle_name'].value = vehicle.vehicle_name || '';
            addVehicleForm.elements['reg_no'].value = vehicle.reg_no || '';
            addVehicleForm.elements['ins_expiry'].value = vehicle.ins_expiry || '';
            addVehicleForm.elements['fitness_expiry'].value = vehicle.fitness_expiry || '';
            addVehicleForm.elements['puc_expiry'].value = vehicle.puc_expiry || '';
            addVehicleForm.elements['driver_name'].value = vehicle.driver_name || '';
            addVehicleForm.elements['driver_contact'].value = vehicle.driver_contact || '';
            addVehicleForm.elements['driver_alt_contact'].value = vehicle.driver_alt_contact || '';
            addVehicleForm.elements['driver_experience'].value = vehicle.driver_experience || '';
            addVehicleForm.elements['driver_adhar'].value = vehicle.driver_adhar || '';
            addVehicleForm.elements['loan_total'].value = vehicle.loan_total || 0;
            addVehicleForm.elements['loan_paid'].value = vehicle.loan_paid || 0;
            
            showSection('add-vehicle-section');
        }

        async function deleteVehicle(id) {
            try {
                await deleteDoc(doc(getCollection('vehicles'), id));
                showModal('Vehicle deleted successfully!');
            } catch (e) {
                console.error("Error deleting document: ", e);
                showModal('Error deleting vehicle. Please try again.');
            }
        }

        function loadVehicles() {
            if (!db || !userId) return; 
            const q = query(getCollection('vehicles'), orderBy('vehicle_name'));
            onSnapshot(q, (querySnapshot) => {
                vehiclesContainer.innerHTML = '';
                const vehicleList = [];
                querySnapshot.forEach((doc) => {
                    const vehicle = { id: doc.id, ...doc.data() };
                    vehiclesContainer.appendChild(createVehicleCard(vehicle));
                    vehicleList.push(vehicle.vehicle_name);
                });
                
                // Update dropdowns for Trips and Vehicle Expenses
                const updateSelect = (selectId, names) => {
                    const selectElement = document.getElementById(selectId);
                    if (!selectElement) return;
                    const currentValue = selectElement.value;
                    selectElement.innerHTML = '<option value="">Select Vehicle</option>';
                    names.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        selectElement.appendChild(option);
                    });
                    selectElement.value = currentValue; // Retain selection if possible
                };

                updateSelect('trip-vehicle-select', vehicleList);
                updateSelect('vehicle-expenses-vehicle-select', vehicleList);
                updateSelect('trip-vehicle-filter', vehicleList);
                updateSelect('vehicle-expenses-vehicle-filter', vehicleList);
                
            }, (error) => {
                console.error("Error fetching vehicles:", error);
            });
        }

        // --- Trip Logic ---
        const tripsTableBody = document.getElementById('trips-table-body');
        const tripsForm = document.getElementById('trips-form');
        const filterTripsBtn = document.getElementById('filter-trips-btn');
        const tripVehicleFilter = document.getElementById('trip-vehicle-filter');
        const tripDateFilter = document.getElementById('trip-date-filter');

        filterTripsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            loadTrips();
        });
        
        tripsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.submitter;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';
            
            const formData = new FormData(tripsForm);
            const data = Object.fromEntries(formData.entries());
            data.date = new Date().toISOString().split('T')[0]; // Auto-set date

            data.income = parseFloat(data.income) || 0;
            data.expense = parseFloat(data.expense) || 0;
            
            try {
                await addDoc(getCollection('trips'), data);
                showModal('Trip added successfully!');
                tripsForm.reset();
            } catch (e) {
                console.error("Error adding trip: ", e);
                showModal('Error saving trip. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Trip';
            }
        });

        function loadTrips() {
            if (!db || !userId) return;
            const vehicleFilter = tripVehicleFilter.value;
            const dateFilter = tripDateFilter.value;
            const fromDate = getDateFilterRange(dateFilter);
            
            let q = query(getCollection('trips'), orderBy('date', 'desc')); 
            
            if (vehicleFilter) {
                q = query(q, where('vehicle', '==', vehicleFilter));
            }
            
            onSnapshot(q, (querySnapshot) => {
                tripsTableBody.innerHTML = '';
                let totalIncome = 0;
                let totalExpense = 0;
                
                const allTrips = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Manual date filtering on the client side
                const filteredTrips = allTrips.filter(trip => {
                    if (!fromDate || !trip.date) return true;
                    const tripDate = new Date(trip.date);
                    return tripDate >= fromDate;
                });

                filteredTrips.forEach(trip => {
                    const income = parseFloat(trip.income) || 0;
                    const expense = parseFloat(trip.expense) || 0;
                    const profit = income - expense;
                    const row = tripsTableBody.insertRow();
                    row.className = 'border-t border-gray-700 hover:bg-gray-800 transition-colors duration-150';
                    row.innerHTML = `
                        <td class="py-3 px-4 text-sm">${trip.date}</td>
                        <td class="py-3 px-4 text-sm">${trip.vehicle}</td>
                        <td class="py-3 px-4 text-sm">${trip.destination}</td>
                        <td class="py-3 px-4 text-sm text-green-400">₹${income.toFixed(2)}</td>
                        <td class="py-3 px-4 text-sm text-red-400">₹${expense.toFixed(2)}</td>
                        <td class="py-3 px-4 text-sm font-semibold ${profit >= 0 ? 'text-green-300' : 'text-red-300'}">₹${profit.toFixed(2)}</td>
                        <td class="py-3 px-4">
                            <button class="delete-trip-btn text-red-500 hover:text-red-700 transition-colors duration-200" data-id="${trip.id}"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                    row.querySelector('.delete-trip-btn').addEventListener('click', () => {
                        if(confirm('Are you sure you want to delete this trip record?')) deleteTrip(trip.id)
                    });

                    totalIncome += income;
                    totalExpense += expense;
                });
                
                const totalProfit = totalIncome - totalExpense;
                document.getElementById('trip-income-total').textContent = `₹${totalIncome.toFixed(2)}`;
                document.getElementById('trip-expense-total').textContent = `₹${totalExpense.toFixed(2)}`;
                document.getElementById('trip-profit-total').textContent = `₹${totalProfit.toFixed(2)}`;
                document.getElementById('trip-profit-total').classList.toggle('text-red-400', totalProfit < 0);
                document.getElementById('trip-profit-total').classList.toggle('text-green-400', totalProfit >= 0);
            }, (error) => {
                console.error("Error fetching trips:", error);
            });
        }
        
        async function deleteTrip(id) {
            try {
                await deleteDoc(doc(getCollection('trips'), id));
                showModal('Trip record deleted successfully!');
            } catch (e) {
                console.error("Error deleting trip: ", e);
                showModal('Error deleting trip record. Please try again.');
            }
        }
        
        // --- Vehicle Expenses Logic ---
        const vehicleExpensesForm = document.getElementById('vehicle-expenses-form');
        const vehicleExpensesTableBody = document.getElementById('vehicle-expenses-table-body');
        const vehicleExpensesVehicleFilter = document.getElementById('vehicle-expenses-vehicle-filter');
        const vehicleExpensesDateFilter = document.getElementById('vehicle-expenses-date-filter');

        document.getElementById('filter-vehicle-expenses-btn').addEventListener('click', (e) => {
            e.preventDefault();
            loadVehicleExpenses();
        });

        vehicleExpensesForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.submitter;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';

            const formData = new FormData(vehicleExpensesForm);
            const data = Object.fromEntries(formData.entries());
            data.date = new Date().toISOString().split('T')[0];
            data.amount = parseFloat(data.amount) || 0;
            
            try {
                await addDoc(getCollection('vehicle_expenses'), data);
                showModal('Vehicle expense added successfully!');
                vehicleExpensesForm.reset();
            } catch (e) {
                console.error("Error adding vehicle expense: ", e);
                showModal('Error saving vehicle expense. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Expense';
            }
        });

        function loadVehicleExpenses() {
            if (!db || !userId) return;
            const vehicleFilter = vehicleExpensesVehicleFilter.value;
            const dateFilter = vehicleExpensesDateFilter.value;
            const fromDate = getDateFilterRange(dateFilter);
            
            let q = query(getCollection('vehicle_expenses'), orderBy('date', 'desc'));
            
            if (vehicleFilter) {
                q = query(q, where('vehicle', '==', vehicleFilter));
            }
            
            onSnapshot(q, (querySnapshot) => {
                vehicleExpensesTableBody.innerHTML = '';
                let totalAmount = 0;
                
                const allExpenses = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Manual date filtering
                const filteredExpenses = allExpenses.filter(expense => {
                    if (!fromDate || !expense.date) return true;
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= fromDate;
                });

                filteredExpenses.forEach(expense => {
                    const amount = parseFloat(expense.amount) || 0;
                    const row = vehicleExpensesTableBody.insertRow();
                    row.className = 'border-t border-gray-700 hover:bg-gray-800 transition-colors duration-150';
                    row.innerHTML = `
                        <td class="py-3 px-4 text-sm">${expense.date}</td>
                        <td class="py-3 px-4 text-sm">${expense.vehicle}</td>
                        <td class="py-3 px-4 text-sm">${expense.expense_type}</td>
                        <td class="py-3 px-4 text-sm">${expense.details}</td>
                        <td class="py-3 px-4 text-sm text-red-400 font-semibold">₹${amount.toFixed(2)}</td>
                        <td class="py-3 px-4">
                            <button class="delete-expense-btn text-red-500 hover:text-red-700 transition-colors duration-200" data-id="${expense.id}"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                    row.querySelector('.delete-expense-btn').addEventListener('click', () => {
                        if(confirm('Are you sure you want to delete this expense record?')) deleteVehicleExpense(expense.id)
                    });

                    totalAmount += amount;
                });
                document.getElementById('vehicle-expense-total').textContent = `₹${totalAmount.toFixed(2)}`;
            }, (error) => {
                console.error("Error fetching vehicle expenses:", error);
            });
        }
        
        async function deleteVehicleExpense(id) {
            try {
                await deleteDoc(doc(getCollection('vehicle_expenses'), id));
                showModal('Expense record deleted successfully!');
            } catch (e) {
                console.error("Error deleting expense: ", e);
                showModal('Error deleting expense record. Please try again.');
            }
        }

        // --- Office Expenses Logic ---
        const officeExpensesForm = document.getElementById('office-expenses-form');
        const officeExpensesList = document.getElementById('office-expenses-list');
        
        officeExpensesForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = e.submitter;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';

            const formData = new FormData(officeExpensesForm);
            const data = Object.fromEntries(formData.entries());
            data.date = new Date().toISOString().split('T')[0];
            data.amount = parseFloat(data.amount) || 0;
            
            try {
                await addDoc(getCollection('office_expenses'), data);
                showModal('Office expense added successfully!');
                officeExpensesForm.reset();
            } catch (e) {
                console.error("Error adding office expense: ", e);
                showModal('Error saving office expense. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Office Expense';
            }
        });

        function loadOfficeExpenses() {
             if (!db || !userId) return;
             const q = query(getCollection('office_expenses'), orderBy('date', 'desc'));
            
             onSnapshot(q, (querySnapshot) => {
                officeExpensesList.innerHTML = '';
                const expenses = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Group expenses by category
                const groupedExpenses = expenses.reduce((acc, expense) => {
                    const type = expense.expense_type;
                    if (!acc[type]) acc[type] = [];
                    acc[type].push(expense);
                    return acc;
                }, {});

                // Calculate totals for summary cards
                const newTotals = { Rent: 0, Bills: 0, Salary: 0, Other: 0, total: 0 };
                let totalOfficeExpense = 0;
                
                querySnapshot.forEach(doc => {
                    const expense = doc.data();
                    const amount = parseFloat(expense.amount) || 0;
                    totalOfficeExpense += amount;
                    if (newTotals.hasOwnProperty(expense.expense_type)) {
                        newTotals[expense.expense_type] += amount;
                    } else {
                        newTotals.Other += amount; // Fallback to 'Other' if type is custom
                    }
                });

                document.getElementById('office-rent-total').textContent = `₹${newTotals.Rent.toFixed(2)}`;
                document.getElementById('office-bills-total').textContent = `₹${newTotals.Bills.toFixed(2)}`;
                document.getElementById('office-salary-total').textContent = `₹${newTotals.Salary.toFixed(2)}`;
                document.getElementById('office-other-total').textContent = `₹${newTotals.Other.toFixed(2)}`;
                document.getElementById('office-total-total').textContent = `₹${totalOfficeExpense.toFixed(2)}`;

                // Render detail list
                expenses.forEach(expense => {
                    const amount = parseFloat(expense.amount) || 0;
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-[#1f1f1f] p-4 rounded-lg shadow-md hover:bg-gray-800 transition-colors duration-150';
                    li.innerHTML = `
                        <div>
                            <p class="font-semibold text-white">${expense.expense_type} - ${expense.details}</p>
                            <p class="text-xs text-gray-400">${expense.date}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="text-lg text-red-400 font-bold">₹${amount.toFixed(2)}</span>
                            <button class="delete-office-expense-btn text-red-500 hover:text-red-700 transition-colors duration-200" data-id="${expense.id}"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    li.querySelector('.delete-office-expense-btn').addEventListener('click', () => {
                        if(confirm('Are you sure you want to delete this office expense?')) deleteOfficeExpense(expense.id)
                    });
                    officeExpensesList.appendChild(li);
                });

            }, (error) => {
                 console.error("Error fetching office expenses:", error);
            });
        }
        
        async function deleteOfficeExpense(id) {
            try {
                await deleteDoc(doc(getCollection('office_expenses'), id));
                showModal('Office expense deleted successfully!');
            } catch (e) {
                console.error("Error deleting office expense: ", e);
                showModal('Error deleting office expense. Please try again.');
            }
        }
        
    </script>
    
    <!-- Navigation Bar -->
    <header class="bg-card-bg shadow-lg sticky top-0 z-10">
        <div class="flex flex-col md:flex-row justify-between items-center p-3 px-6 max-w-7xl mx-auto">
            <div class="flex items-center space-x-4">
                <i class="fas fa-truck text-accent-blue text-2xl"></i>
                <h1 class="text-2xl font-bold text-white tracking-wider">KTS Transport</h1>
            </div>
            <div id="user-info" class="text-xs text-gray-400 mt-2 md:mt-0" title="This ID is unique to your session/user for data persistence.">
                <span id="user-id-display">User ID: Loading...</span>
                <p id="error-message" class="text-red-400 font-semibold"></p>
            </div>
        </div>
    </header>

    <!-- Main Content Layout -->
    <div class="main-container flex">
        <!-- Sidebar Navigation -->
        <nav class="w-16 md:w-56 bg-card-bg shadow-2xl p-3 space-y-2 flex-shrink-0">
            <a href="#" class="nav-link flex items-center p-3 rounded-xl transition-colors duration-200 bg-accent-blue" data-section="home">
                <i class="fas fa-tachometer-alt text-xl md:mr-3"></i>
                <span class="hidden md:inline font-semibold">Dashboard</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 rounded-xl transition-colors duration-200 bg-gray-800 hover:bg-gray-700" data-section="vehicles">
                <i class="fas fa-truck-moving text-xl md:mr-3"></i>
                <span class="hidden md:inline font-semibold">Vehicles</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 rounded-xl transition-colors duration-200 bg-gray-800 hover:bg-gray-700" data-section="trips">
                <i class="fas fa-route text-xl md:mr-3"></i>
                <span class="hidden md:inline font-semibold">Trips & Income</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 rounded-xl transition-colors duration-200 bg-gray-800 hover:bg-gray-700" data-section="vehicle-expenses">
                <i class="fas fa-gas-pump text-xl md:mr-3"></i>
                <span class="hidden md:inline font-semibold">Vehicle Expenses</span>
            </a>
            <a href="#" class="nav-link flex items-center p-3 rounded-xl transition-colors duration-200 bg-gray-800 hover:bg-gray-700" data-section="office-expenses">
                <i class="fas fa-building text-xl md:mr-3"></i>
                <span class="hidden md:inline font-semibold">Office Expenses</span>
            </a>
        </nav>

        <!-- Content Area -->
        <main class="scroll-container w-full">
            
            <!-- 1. Dashboard Section -->
            <section id="home" class="space-y-8">
                <h2 class="text-3xl font-extrabold text-accent-blue border-b border-gray-700 pb-2">Dashboard Summary</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Card 1: Total Vehicles -->
                    <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                        <i class="fas fa-truck-moving text-3xl text-yellow-400 mb-3"></i>
                        <p class="text-gray-400 uppercase text-sm font-medium">Total Vehicles</p>
                        <p id="total-vehicles" class="text-4xl font-bold mt-1 text-white">0</p>
                    </div>
                    <!-- Card 2: Recent Profit -->
                    <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                        <i class="fas fa-chart-line text-3xl text-green-400 mb-3"></i>
                        <p class="text-gray-400 uppercase text-sm font-medium">Trip Profit (Last 30 Days)</p>
                        <p id="recent-profit" class="text-4xl font-bold mt-1 text-green-400">₹0.00</p>
                    </div>
                    <!-- Card 3: Recent Expenses -->
                    <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700">
                        <i class="fas fa-money-bill-wave text-3xl text-red-400 mb-3"></i>
                        <p class="text-gray-400 uppercase text-sm font-medium">Vehicle Expenses (Last 30 Days)</p>
                        <p id="recent-expenses" class="text-4xl font-bold mt-1 text-red-400">₹0.00</p>
                    </div>
                </div>

                <div class="mt-8 p-6 bg-card-bg rounded-xl shadow-lg border border-gray-700">
                    <h3 class="text-xl font-semibold mb-4 text-accent-blue">KTS Status</h3>
                    <p class="text-gray-300">Welcome to your Transport Management Dashboard. Use the sidebar to manage vehicles, log trip details, and track your operational expenses.</p>
                    <ul class="mt-4 space-y-2 text-sm text-gray-400">
                        <li><i class="fas fa-check-circle text-green-500 mr-2"></i> Real-time data sync powered by Firestore.</li>
                        <li><i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i> Remember to check vehicle expiry dates regularly.</li>
                    </ul>
                </div>
            </section>

            <!-- 2. Vehicles Section -->
            <section id="vehicles" class="hidden space-y-6">
                <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                    <h2 class="text-3xl font-extrabold text-accent-blue">Vehicle Management</h2>
                    <button id="add-vehicle-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200 shadow-md">
                        <i class="fas fa-plus mr-1"></i> Add New Vehicle
                    </button>
                </div>
                
                <!-- Vehicle Cards Container -->
                <div id="vehicles-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Vehicle Cards will be inserted here by JS -->
                </div>

                <div class="text-center p-4 text-gray-400" id="no-vehicles-message">
                    <!-- Message if no vehicles are loaded -->
                </div>
            </section>
            
            <!-- 2a. Add/Edit Vehicle Section (Hidden initially) -->
            <section id="add-vehicle-section" class="hidden space-y-6 max-w-3xl mx-auto">
                <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                    <h2 id="vehicle-form-title" class="text-3xl font-extrabold text-accent-blue">Add New Vehicle</h2>
                    <button id="back-to-vehicles" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200 shadow-md">
                        <i class="fas fa-arrow-left mr-1"></i> Back to List
                    </button>
                </div>

                <form id="add-vehicle-form" class="space-y-6 bg-card-bg p-8 rounded-xl shadow-lg border border-gray-700">
                    <input type="hidden" name="id" id="vehicle-id">

                    <!-- Vehicle Details -->
                    <fieldset class="border border-gray-600 p-4 rounded-lg space-y-4">
                        <legend class="text-lg font-semibold text-accent-blue px-2">Vehicle Information</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="vehicle_name" class="block text-sm font-medium mb-1">Vehicle Name / Model</label>
                                <input type="text" name="vehicle_name" required placeholder="E.g., TATA 407" class="w-full">
                            </div>
                            <div>
                                <label for="reg_no" class="block text-sm font-medium mb-1">Registration No. (Reg No)</label>
                                <input type="text" name="reg_no" required placeholder="E.g., MH 12 AB 1234" class="w-full">
                            </div>
                            <div>
                                <label for="ins_expiry" class="block text-sm font-medium mb-1">Insurance Expiry Date</label>
                                <input type="date" name="ins_expiry" class="w-full">
                            </div>
                            <div>
                                <label for="fitness_expiry" class="block text-sm font-medium mb-1">Fitness Expiry Date</label>
                                <input type="date" name="fitness_expiry" class="w-full">
                            </div>
                            <div class="md:col-span-2">
                                <label for="puc_expiry" class="block text-sm font-medium mb-1">PUC Expiry Date</label>
                                <input type="date" name="puc_expiry" class="w-full">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Driver Details -->
                    <fieldset class="border border-gray-600 p-4 rounded-lg space-y-4">
                        <legend class="text-lg font-semibold text-accent-blue px-2">Driver Information</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="driver_name" class="block text-sm font-medium mb-1">Driver Name</label>
                                <input type="text" name="driver_name" placeholder="Driver's Full Name" class="w-full">
                            </div>
                            <div>
                                <label for="driver_contact" class="block text-sm font-medium mb-1">Contact No</label>
                                <input type="tel" name="driver_contact" placeholder="9876543210" class="w-full">
                            </div>
                            <div>
                                <label for="driver_alt_contact" class="block text-sm font-medium mb-1">Alternate Contact No</label>
                                <input type="tel" name="driver_alt_contact" class="w-full">
                            </div>
                            <div>
                                <label for="driver_experience" class="block text-sm font-medium mb-1">Experience (Years)</label>
                                <input type="number" name="driver_experience" min="0" placeholder="5" class="w-full">
                            </div>
                            <div class="md:col-span-2">
                                <label for="driver_adhar" class="block text-sm font-medium mb-1">Aadhar Number</label>
                                <input type="text" name="driver_adhar" placeholder="XXXX XXXX XXXX" class="w-full">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Loan Details -->
                    <fieldset class="border border-gray-600 p-4 rounded-lg space-y-4">
                        <legend class="text-lg font-semibold text-accent-blue px-2">Loan Details (₹)</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="loan_total" class="block text-sm font-medium mb-1">Total Loan Amount</label>
                                <input type="number" step="0.01" name="loan_total" value="0" min="0" class="w-full">
                            </div>
                            <div>
                                <label for="loan_paid" class="block text-sm font-medium mb-1">Amount Paid So Far</label>
                                <input type="number" step="0.01" name="loan_paid" value="0" min="0" class="w-full">
                            </div>
                        </div>
                    </fieldset>
                    
                    <button type="submit" class="bg-accent-blue hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full w-full shadow-xl transition-colors duration-200">
                        <i class="fas fa-save mr-2"></i> Save Vehicle
                    </button>
                </form>
            </section>

            <!-- 3. Trips & Income Section -->
            <section id="trips" class="hidden space-y-6">
                <h2 class="text-3xl font-extrabold text-accent-blue border-b border-gray-700 pb-2">Trips & Income Log</h2>

                <!-- Add Trip Form -->
                <form id="trips-form" class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700 space-y-4">
                    <h3 class="text-xl font-semibold text-white">Log New Trip Record (Current Date)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="trip-vehicle-select" class="block text-sm font-medium mb-1">Vehicle</label>
                            <select id="trip-vehicle-select" name="vehicle" required>
                                <option value="">Select Vehicle</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="destination" class="block text-sm font-medium mb-1">Destination</label>
                            <input type="text" name="destination" required placeholder="Mumbai/Delhi">
                        </div>
                        <div>
                            <label for="income" class="block text-sm font-medium mb-1">Trip Income (₹)</label>
                            <input type="number" step="0.01" name="income" required value="0" min="0">
                        </div>
                        <div>
                            <label for="expense" class="block text-sm font-medium mb-1">Trip Expense (₹)</label>
                            <input type="number" step="0.01" name="expense" required value="0" min="0">
                        </div>
                    </div>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full w-full transition-colors duration-200 shadow-md">
                        <i class="fas fa-plus mr-1"></i> Add Trip
                    </button>
                </form>

                <!-- Trip Filter & Summary -->
                <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700 space-y-4">
                    <h3 class="text-xl font-semibold text-white">Trip History & Summary</h3>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 items-end">
                        <div class="w-full sm:w-1/3">
                            <label for="trip-vehicle-filter" class="block text-sm font-medium mb-1">Filter by Vehicle</label>
                            <select id="trip-vehicle-filter" class="w-full">
                                <option value="">All Vehicles</option>
                            </select>
                        </div>
                        <div class="w-full sm:w-1/3">
                            <label for="trip-date-filter" class="block text-sm font-medium mb-1">Filter by Date Range</label>
                            <select id="trip-date-filter" class="w-full">
                                <option value="">All Time</option>
                                <option>Last 7 Days</option>
                                <option selected>Last 30 Days</option>
                                <option>Last 6 Months</option>
                                <option>Last 12 Months</option>
                            </select>
                        </div>
                        <button id="filter-trips-btn" class="bg-accent-blue hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200 w-full sm:w-auto">
                            <i class="fas fa-filter mr-1"></i> Apply Filter
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full table-auto rounded-lg overflow-hidden">
                            <thead>
                                <tr>
                                    <th class="w-[10%]">Date</th>
                                    <th class="w-[15%]">Vehicle</th>
                                    <th class="w-[25%]">Destination</th>
                                    <th class="w-[15%] text-green-400">Income (₹)</th>
                                    <th class="w-[15%] text-red-400">Expense (₹)</th>
                                    <th class="w-[15%]">Profit (₹)</th>
                                    <th class="w-[5%]">Action</th>
                                </tr>
                            </thead>
                            <tbody id="trips-table-body" class="divide-y divide-gray-700">
                                <!-- Trip rows inserted here by JS -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-800 font-bold border-t-4 border-accent-blue">
                                    <td colspan="3" class="py-3 px-4 text-right">TOTAL (Filtered)</td>
                                    <td id="trip-income-total" class="py-3 px-4 text-green-400">₹0.00</td>
                                    <td id="trip-expense-total" class="py-3 px-4 text-red-400">₹0.00</td>
                                    <td id="trip-profit-total" class="py-3 px-4 text-white">₹0.00</td>
                                    <td class="py-3 px-4"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 4. Vehicle Expenses Section -->
            <section id="vehicle-expenses" class="hidden space-y-6">
                <h2 class="text-3xl font-extrabold text-accent-blue border-b border-gray-700 pb-2">Vehicle Expenses Log</h2>

                <!-- Add Vehicle Expense Form -->
                <form id="vehicle-expenses-form" class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700 space-y-4">
                    <h3 class="text-xl font-semibold text-white">Record New Vehicle Expense (Current Date)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-4">
                        <div class="sm:col-span-2">
                            <label for="vehicle-expenses-vehicle-select" class="block text-sm font-medium mb-1">Vehicle</label>
                            <select id="vehicle-expenses-vehicle-select" name="vehicle" required>
                                <option value="">Select Vehicle</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label for="expense_type" class="block text-sm font-medium mb-1">Expense Type</label>
                            <select id="expense_type" name="expense_type" required>
                                <option value="Fuel">Fuel</option>
                                <option value="Repair & Maintenance">Repair & Maintenance</option>
                                <option value="Tolls & Permits">Tolls & Permits</option>
                                <option value="Driver Salary/Per Diem">Driver Salary/Per Diem</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="amount" class="block text-sm font-medium mb-1">Amount (₹)</label>
                            <input type="number" step="0.01" name="amount" required value="0" min="0">
                        </div>
                        <div class="sm:col-span-2 md:col-span-5">
                            <label for="details" class="block text-sm font-medium mb-1">Details/Description</label>
                            <input type="text" name="details" required placeholder="E.g., Engine oil change, Diesel fill at HP pump">
                        </div>
                    </div>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full w-full transition-colors duration-200 shadow-md">
                        <i class="fas fa-plus mr-1"></i> Add Expense
                    </button>
                </form>

                 <!-- Expense Filter & Summary -->
                <div class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700 space-y-4">
                    <h3 class="text-xl font-semibold text-white">Expense History & Summary</h3>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 items-end">
                        <div class="w-full sm:w-1/3">
                            <label for="vehicle-expenses-vehicle-filter" class="block text-sm font-medium mb-1">Filter by Vehicle</label>
                            <select id="vehicle-expenses-vehicle-filter" class="w-full">
                                <option value="">All Vehicles</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="w-full sm:w-1/3">
                            <label for="vehicle-expenses-date-filter" class="block text-sm font-medium mb-1">Filter by Date Range</label>
                            <select id="vehicle-expenses-date-filter" class="w-full">
                                <option value="">All Time</option>
                                <option>Last 7 Days</option>
                                <option selected>Last 30 Days</option>
                                <option>Last 6 Months</option>
                                <option>Last 12 Months</option>
                            </select>
                        </div>
                        <button id="filter-vehicle-expenses-btn" class="bg-accent-blue hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200 w-full sm:w-auto">
                            <i class="fas fa-filter mr-1"></i> Apply Filter
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full table-auto rounded-lg overflow-hidden">
                            <thead>
                                <tr>
                                    <th class="w-[10%]">Date</th>
                                    <th class="w-[15%]">Vehicle</th>
                                    <th class="w-[20%]">Type</th>
                                    <th class="w-[40%]">Details</th>
                                    <th class="w-[10%] text-red-400">Amount (₹)</th>
                                    <th class="w-[5%]">Action</th>
                                </tr>
                            </thead>
                            <tbody id="vehicle-expenses-table-body" class="divide-y divide-gray-700">
                                <!-- Expense rows inserted here by JS -->
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-800 font-bold border-t-4 border-accent-blue">
                                    <td colspan="4" class="py-3 px-4 text-right">TOTAL EXPENSE (Filtered)</td>
                                    <td id="vehicle-expense-total" class="py-3 px-4 text-red-400">₹0.00</td>
                                    <td class="py-3 px-4"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 5. Office Expenses Section -->
            <section id="office-expenses" class="hidden space-y-6">
                <h2 class="text-3xl font-extrabold text-accent-blue border-b border-gray-700 pb-2">Office Expenses Log</h2>

                <!-- Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="bg-gray-800 p-4 rounded-lg text-center shadow-lg">
                        <p class="text-sm text-gray-400">Rent</p>
                        <p id="office-rent-total" class="text-xl font-bold text-white">₹0.00</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg text-center shadow-lg">
                        <p class="text-sm text-gray-400">Bills</p>
                        <p id="office-bills-total" class="text-xl font-bold text-white">₹0.00</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg text-center shadow-lg">
                        <p class="text-sm text-gray-400">Salary</p>
                        <p id="office-salary-total" class="text-xl font-bold text-white">₹0.00</p>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg text-center shadow-lg">
                        <p class="text-sm text-gray-400">Other</p>
                        <p id="office-other-total" class="text-xl font-bold text-white">₹0.00</p>
                    </div>
                    <div class="bg-red-900 bg-opacity-30 p-4 rounded-lg text-center shadow-lg border border-red-500">
                        <p class="text-sm text-red-400">TOTAL</p>
                        <p id="office-total-total" class="text-2xl font-bold text-red-300">₹0.00</p>
                    </div>
                </div>

                <!-- Add Office Expense Form -->
                <form id="office-expenses-form" class="bg-card-bg p-6 rounded-xl shadow-lg border border-gray-700 space-y-4">
                    <h3 class="text-xl font-semibold text-white">Record New Office Expense (Current Date)</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                        <div>
                            <label for="office_expense_type" class="block text-sm font-medium mb-1">Expense Category</label>
                            <select id="office_expense_type" name="expense_type" required>
                                <option value="Rent">Rent</option>
                                <option value="Bills">Bills (Electricity, Internet, etc.)</option>
                                <option value="Salary">Salary/Wages</option>
                                <option value="Other">Other Office Supply</option>
                            </select>
                        </div>
                        <div>
                            <label for="office_amount" class="block text-sm font-medium mb-1">Amount (₹)</label>
                            <input type="number" step="0.01" name="amount" required value="0" min="0">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="office_details" class="block text-sm font-medium mb-1">Details/Description</label>
                            <input type="text" name="details" required placeholder="E.g., Office rent for May, Paper and printer ink">
                        </div>
                    </div>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full w-full transition-colors duration-200 shadow-md">
                        <i class="fas fa-plus mr-1"></i> Add Office Expense
                    </button>
                </form>

                <!-- Office Expense History List -->
                <h3 class="text-xl font-semibold text-white border-b border-gray-700 pb-2">Recent Office Expense History</h3>
                <ul id="office-expenses-list" class="space-y-3">
                    <!-- Expense items inserted here by JS -->
                </ul>
            </section>

        </main>
    </div>

    <!-- Custom Modal for Notifications (to replace alert/confirm) -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-card-bg p-6 rounded-xl shadow-2xl max-w-sm w-full text-center border border-accent-blue">
            <i class="fas fa-check-circle text-green-500 text-3xl mb-3"></i>
            <p id="modal-message" class="text-white text-lg font-semibold"></p>
            <button id="close-modal-btn" class="mt-4 bg-accent-blue hover:bg-blue-600 text-white py-1 px-4 rounded-full text-sm">Close</button>
        </div>
    </div>

</body>
</html>